<h1>–ß–∞—Ç —Å <%= @other.username %></h1>

<div class="chat-top-bar">
  <%= link_to "‚¨Ö –ö —Å–ø–∏—Å–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", users_path, class: "btn" %>
  <%= link_to "–û–±–Ω–æ–≤–∏—Ç—å", user_messages_path(@other), class: "btn" %>
</div>

<section class="chat-panel">
  <div class="chat-messages" >
    <% @messages.each do |m| %>
      <p>
        <%= image_tag(m.sender.avatar || "avatars/default.png",
                      style: "border-color: #{['#FF0000','#00FF00','#0000FF','#FFA500'].sample};",
                      class: "user-avatar") %>
        <strong><%= m.sender.username %>:</strong>
        <%= m.content %>

        <% if m.file.attached? %>
          <br>
          <% if m.file.image? %>
            <%= link_to url_for(m.file), target: "_blank" do %>
              <%= image_tag m.file, style: "max-width: 200px; display: block; margin-top: 5px; border:1px solid #ccc; border-radius:4px;" %>
            <% end %>
          <% elsif m.file.content_type.start_with?('audio') %>
            <audio controls style="margin-top: 5px;">
              <source src="<%= url_for(m.file) %>" type="<%= m.file.content_type %>">
              –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ.
            </audio>
          <% elsif m.file.content_type.start_with?('video') %>
            <video controls style="max-width: 300px; display: block; margin-top: 5px; border:1px solid #ccc; border-radius:4px;">
              <source src="<%= url_for(m.file) %>" type="<%= m.file.content_type %>">
              –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
            </video>
          <% else %>
            üìé <%= link_to m.file.filename, url_for(m.file) %>
          <% end %>
        <% end %>

        <% if m.reply_to.present? %>
          <br><small>‚Ü≥ –í –æ—Ç–≤–µ—Ç –Ω–∞: <%= truncate(m.reply_to.content, length: 30) %></small>
        <% end %>
        <br><small><%= formatted_time(m) %></small>
        <%= link_to "–û—Ç–≤–µ—Ç–∏—Ç—å", user_messages_path(@other, reply_to: m.id), class: "btn btn-sm", style: "float: right" %>
      </p>
    <% end %>
  </div>

  <%= form_with model: [@other, @message], local: true do |f| %>
    <%= f.hidden_field :reply_to_id %>
    <p>
      <%= f.label :content, "–°–æ–æ–±—â–µ–Ω–∏–µ" %><br>
      <%= f.text_area :content, style: "height: 80px" %>
      <% if @message.errors[:content].any? %>
      <div class="error"><%= @message.errors[:content].first %></div>
    <% end %>



    <div class = "send-block">
    <p><%= f.submit "–û—Ç–ø—Ä–∞–≤–∏—Ç—å", class: "btn" %>
      <% if @message.reply_to_id.present? %> <%= link_to "–û—Ç–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç", user_messages_path(@other), class: "btn btn-sm" %> <% end %>
      <p>
        <label class="btn" style="position: relative;">
          üìé –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª
          <%= f.file_field :file, style: "display: none;",
                           onchange: "this.nextElementSibling.innerText = this.files[0]?.name || '–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω'" %>
          <span class="filename" style="margin-left: 10px; font-size: 12px; color: #555;">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
        </label>
      </p>
    </div>
  <% end %>
</section>